import{z as I,E as q,I as x,J as y,K as A,N as G,j as e,d as R,n as w,a as l,o as b,O as M,T as g,Q as Y,x as j,r as v,U as B,G as s,B as $,V as k,v as U,W as Q,X as V,Y as W,Z as z,$ as Z,a0 as K,a1 as S,a2 as J,e as P,a3 as F,a4 as H,a5 as X,a6 as ee,M as te,a7 as ne,a8 as re}from"./index.8535afb5.js";import{d as ae}from"./index.7b135791.js";var ie=6e4;function O(n,t){I(2,arguments);var r=x(t);return q(n,r*ie)}function se(n){I(1,arguments);var t=y(n),r=t.getFullYear(),i=t.getMonth(),o=new Date(0);return o.setFullYear(r,i+1,0),o.setHours(0,0,0,0),o.getDate()}function oe(n,t){I(2,arguments);var r=y(n),i=y(t);return r.getTime()>i.getTime()}function ce(n,t){I(2,arguments);var r=y(n),i=y(t);return r.getTime()<i.getTime()}function le(n,t){I(2,arguments);var r=y(n),i=y(t);return r.getTime()===i.getTime()}function de(n,t){I(2,arguments);var r=y(n),i=x(t),o=r.getFullYear(),c=r.getDate(),a=new Date(0);a.setFullYear(o,i,15),a.setHours(0,0,0,0);var d=se(a);return r.setMonth(i,Math.min(c,d)),r}function N(n){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?N=function(r){return typeof r}:N=function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},N(n)}function ue(n,t){if(I(2,arguments),N(t)!=="object"||t===null)throw new RangeError("values parameter must be an object");var r=y(n);return isNaN(r.getTime())?new Date(NaN):(t.year!=null&&r.setFullYear(t.year),t.month!=null&&(r=de(r,t.month)),t.date!=null&&r.setDate(x(t.date)),t.hours!=null&&r.setHours(x(t.hours)),t.minutes!=null&&r.setMinutes(x(t.minutes)),t.seconds!=null&&r.setSeconds(x(t.seconds)),t.milliseconds!=null&&r.setMilliseconds(x(t.milliseconds)),r)}function he(n,t){I(2,arguments);var r=x(t);return O(n,-r)}function me(n){return n.reduce((i,o)=>{const c=ue(new Date(o.createdAt),{hours:0,minutes:0,seconds:0,milliseconds:0}),a=i.findIndex(d=>le(d.date,c));return a>-1?(i[a].messages.push(o),i):[...i,{date:c,messages:[o]}]},[]).map(i=>{const o=i.messages.reduce((a,d)=>{const u=new Date(d.createdAt),p=a.findIndex(h=>!h.closed&&h.read===d.read&&h.senderId===d.senderId&&oe(u,h.since)&&ce(u,h.to));return p>-1?(a[p].content.push(d),a):(a.length>0&&(a[a.length-1].closed=!0),[...a,{closed:!1,content:[d],read:d.read,senderId:d.senderId,since:he(u,5),to:O(u,5)}])},[]),c=ae(i.date,new Date);return{messages:o,title:c===0?"Hoy":c===-1?"Ayer":A(i.date,"dd MMMM/yyyy",{locale:G})}}).map(({messages:i,title:o})=>({messages:i.map(({content:c})=>c),title:o}))}function ge({color:n=R.color,size:t=R.size,...r}){return e("svg",{...r,height:t,viewBox:"0 0 48 48",width:t,xmlns:"http://www.w3.org/2000/svg",children:e("path",{d:"M24.05 41.7q-1.25 0-2.125-.875t-.875-2.075q0-1.2.875-2.1.875-.9 2.075-.9 1.25 0 2.1.9.85.9.85 2.1 0 1.2-.85 2.075-.85.875-2.05.875Zm0-14.75q-1.25 0-2.125-.875T21.05 24q0-1.25.875-2.1.875-.85 2.075-.85 1.25 0 2.1.85.85.85.85 2.05 0 1.25-.85 2.125t-2.05.875Zm0-14.7q-1.25 0-2.125-.875T21.05 9.25q0-1.25.875-2.125T24 6.25q1.25 0 2.1.875.85.875.85 2.125t-.85 2.125q-.85.875-2.05.875Z",fill:n})})}function L({classes:n,data:t}){const{data:r}=w(),i=t[0].senderUser;if(!r||!i)return null;const o=r.id===t[0].senderId;return e("div",{className:n.chatMessage,children:t.map((c,a)=>l("div",{className:b(n.chatMessage__content,{[n["chatMessage__content--end"]]:o}),children:[!o&&a===0&&e(M,{url:i.profileImage,size:"small"}),l("div",{className:b(n.chatMessage__content__message,{[n["chatMessage__content__message--margin"]]:a>0}),children:[e(g,{withLetterSpacing:!0,className:n.chatMessage__content__message__text,fontSize:14,children:c.content}),a===t.length-1&&e(g,{withLetterSpacing:!0,className:n.chatMessage__content__message__date,fontSize:10,children:A(new Date(c.createdAt),"hh:mm a")})]}),o&&a===0&&e(M,{url:i.profileImage,size:"small"})]},`chat_message_${c.id}_${a}`))})}function fe({chatId:n,classes:t,loading:r,messages:i}){const{data:o}=w();if(r)return e(Y,{id:"chat-messages-loader",text:"Cargando"});const c=me(i);return e(j,{children:c.map(({messages:a,title:d},u)=>{const p=u===c.length-1?a.reduce((m,f)=>!f[0].read&&f[0].senderId!==(o==null?void 0:o.id)?m+f.length:m,0):0;let h=!1;return l("div",{className:t.chatBox__content__grouped,id:u===c.length-1?"chat-grouped-messages":void 0,children:[e(g,{className:t.chatBox__content__grouped__title,fontSize:12,fontWeight:500,children:d}),e("div",{className:t.chatBox__content__grouped__messages,children:a.map((m,f)=>p>0&&!m[0].read&&m[0].senderId!==(o==null?void 0:o.id)&&!h?(h=!0,l(v.exports.Fragment,{children:[l(g,{withLetterSpacing:!0,className:t.chatBox__content__grouped__messages__unread,fontSize:12,children:[p," mensaje",p===1?"":"s"," no le\xEDdo",p===1?"":"s"]}),e(L,{classes:t,data:m})]},`chat_message_${n}_${m.length}_${u}_${f}`)):e(L,{classes:t,data:m},`chat_message_${n}_${m.length}_${u}_${f}`))})]},`chat_grouped_message_${a.length}_${u}`)})})}function _e({user:n}){return e(B,{fullHeight:!0,children:l(s,{container:!0,alignItems:"center",direction:"column",justifyContent:"center",spacing:12,children:[e(s,{item:!0,children:e(M,{size:"big",url:n.profileImage})}),e(s,{item:!0,children:e(g,{variant:"title",children:n.username})}),l(s,{item:!0,children:[e($,{fullWidth:!0,link:!0,color:"white",size:"small",to:k.replace(":username",n.username),variant:"outlined",children:"Ver perfil"}),e($,{color:"error",onClick:()=>{},size:"small",style:{marginTop:12},children:"Borrar conversaci\xF3n"})]})]})})}function pe({chatId:n,classes:t,refetchRecentChats:r,updateMessages:i,user:o}){const[c,a]=v.exports.useState(""),d=v.exports.useRef(null),{data:u}=w(),[p]=U(Q,{onCompleted({readAllMessages:_}){!_||(r(),i(D=>({...D,messages:D.messages.map(C=>!C.read&&C.senderId!==(u==null?void 0:u.id)?{...C,read:!0}:C)})))}}),[h,{loading:m}]=U(V,{onCompleted(){a(""),r(),setTimeout(()=>{d.current&&d.current.focus()},100)}});function f(_){a(_.target.value)}function T(){p({variables:{chatId:n}})}function E(_){_.key==="Enter"&&c.length>0&&h({variables:{chatId:n,content:c}})}return e("div",{className:t.chatBox__footer,children:e(s,{container:!0,children:e(s,{item:!0,xs:"auto",children:e("input",{autoComplete:"off",className:t.chatBox__footer__input,disabled:m,onChange:f,onFocus:T,onKeyDown:E,placeholder:`Mensaje para ${o.username}`,ref:d,value:c})})})})}function ye({classes:n,onClick:t,user:r}){return e("div",{className:n.chatBox__header,children:l(s,{container:!0,alignItems:"center",justifyContent:"space-between",children:[e(s,{item:!0,children:e("button",{className:n.chatBox__header__button,onClick:t,children:l(s,{container:!0,alignItems:"center",spacing:12,children:[e(s,{item:!0,children:e(M,{clickable:!0,url:r.profileImage,size:"small"})}),e(s,{item:!0,children:e(g,{variant:"subtitle",children:r.username})})]})})}),e(s,{item:!0,children:e(W,{color:"white",onClick:t,size:"small",variant:"transparent",children:e(ge,{})})})]})})}function xe({chatId:n,refetchRecentChats:t}){var m;const[r,i]=v.exports.useState(!1),o=v.exports.useRef(null),{data:c}=w(),{data:a,loading:d,updateQuery:u,subscribeToMore:p}=z(Z,{variables:{chatId:n}});if(v.exports.useEffect(()=>{p({document:K,variables:{chatId:n},updateQuery(f,{subscriptionData:T}){if(!T.data)return f;t();const E=T.data.newPrivateMessage;if(E.senderId!==(c==null?void 0:c.id)){const _=document.createElement("audio");_.src="/sounds/new_message.mp3",_.style.display="none",_.addEventListener("ended",function(){_.remove()}),document.body.appendChild(_),_.play()}return{...f,messages:[...f.messages,E]}}})},[]),v.exports.useEffect(()=>{!o.current||!(a!=null&&a.messages)||o.current.scrollTo(0,o.current.scrollHeight)},[a]),!c)return null;const h=(a==null?void 0:a.chat.toId)===c.id?a.chat.user:a==null?void 0:a.chat.toUser;return h?l(s,{container:!0,spacing:12,children:[e(s,{item:!0,style:{height:"calc(100vh - 48px - 50px)"},xs:r?9:12,children:l(B,{fullHeight:!0,noPadding:!0,className:S.chatBox,children:[e(ye,{classes:S,onClick:()=>i(!r),user:h}),e("div",{className:S.chatBox__content,ref:o,children:e(fe,{chatId:n,classes:S,loading:d,messages:(m=a==null?void 0:a.messages)!=null?m:[]})}),e(pe,{chatId:n,classes:S,refetchRecentChats:t,updateMessages:u,user:h})]})}),r&&e(s,{item:!0,xs:3,children:e(_e,{classes:S,user:h})})]}):null}function Ie({data:n}){const{data:t}=w(),r=J();if(t==null)return null;const i=n.chat.toId===t.id?n.chat.user:n.chat.toUser;return i?e(P,{className:b(F.messagePreview,{[F["messagePreview--active"]]:r.pathname===H.replace(":chatId",n.chat.id.toString())}),to:H.replace(":chatId",n.chat.id.toString()),children:l(s,{container:!0,alignItems:"center",spacing:24,children:[e(s,{item:!0,children:e(M,{url:i.profileImage})}),e(s,{item:!0,xs:9,children:l(s,{container:!0,justifyContent:"space-between",children:[e(s,{item:!0,children:e(g,{withLetterSpacing:!0,fontSize:18,fontWeight:500,children:i.username})}),e(s,{item:!0,children:e(g,{fontSize:12,children:A(new Date(n.lastMessage.createdAt),"hh:mm a")})}),e(s,{item:!0,xs:10,children:l(g,{style:{color:"#6A6B70",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},variant:"body",children:[n.lastMessage.senderId===t.id?"T\xFA: ":null,n.lastMessage.content]})}),Boolean(n.unread)&&e(s,{item:!0,children:e(X,{counter:n.unread})})]})})]})}):null}function ve(){return l(s,{container:!0,fullHeight:!0,alignItems:"center",direction:"column",justifyContent:"center",spacing:16,children:[e(s,{item:!0,xs:4,children:e("img",{alt:"Begin chat",src:"/images/begin-chat.svg",width:"100%"})}),e(s,{item:!0,children:l(s,{container:!0,alignItems:"center",direction:"column",spacing:4,children:[e(s,{item:!0,children:e(g,{variant:"title",children:"Selecciona una conversaci\xF3n"})}),e(s,{item:!0,children:l(g,{variant:"body",children:["Si no tienes una conversaci\xF3n puedes buscar"," ",e(P,{to:"/explore",children:"nuevas conexiones"})]})})]})})]})}function we(){var o;const{chatId:n}=ee(),{data:t,refetch:r}=z(re),i=(o=t==null?void 0:t.getRecentChats)!=null?o:[];return e(te,{children:e(s,{item:!0,xs:12,children:l(s,{container:!0,fullHeight:!0,spacing:12,children:[e(s,{item:!0,children:e("div",{style:{height:"calc(100vh - 48px)",maxHeight:"calc(100vh - 48px)",width:320},children:l(B,{fullHeight:!0,noPadding:!0,children:[e(g,{withLetterSpacing:!0,component:"h3",style:{padding:"16px 24px"},variant:"title",children:"Conversaciones"}),i.length>0?i.map((c,a)=>e(Ie,{data:c},`chat_${c.chat.id}_${a}`)):e(s,{container:!0,alignItems:"center",direction:"column",children:e(s,{item:!0,children:e(g,{children:"No tienes conversaciones"})})})]})})}),l(s,{item:!0,xs:"auto",children:[e(ne,{}),e("div",{style:{marginTop:12},children:n?e(xe,{chatId:n,refetchRecentChats:r}):e(ve,{})})]})]})})})}export{we as default};
