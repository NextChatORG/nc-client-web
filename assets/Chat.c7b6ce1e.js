import{j as n,k as Z,n as v,a as l,c as C,r as I,G as K,o as U,p as V,S as J,N as X,q as _,F as ee,s as te,L as z,t as F,v as ne,w as re}from"./index.deb74e2b.js";import{r as y,a as se,t as x,b as h,d as ae,f as A,e as ie,A as b,T as m,u as G,C as Y,I as oe,L as ce,B as le,M as ue,S as de}from"./MainTemplate.c6f11e3c.js";import{d as H,G as o}from"./Logo.3db86807.js";import"./TextField.0e4a46a5.js";function me({color:t=H.color,size:e=H.size,...r}){return n("svg",{...r,height:e,viewBox:"0 0 48 48",width:e,xmlns:"http://www.w3.org/2000/svg",children:n("path",{d:"M24.05 41.7q-1.25 0-2.125-.875t-.875-2.075q0-1.2.875-2.1.875-.9 2.075-.9 1.25 0 2.1.9.85.9.85 2.1 0 1.2-.85 2.075-.85.875-2.05.875Zm0-14.75q-1.25 0-2.125-.875T21.05 24q0-1.25.875-2.1.875-.85 2.075-.85 1.25 0 2.1.85.85.85.85 2.05 0 1.25-.85 2.125t-2.05.875Zm0-14.7q-1.25 0-2.125-.875T21.05 9.25q0-1.25.875-2.125T24 6.25q1.25 0 2.1.875.85.875.85 2.125t-.85 2.125q-.85.875-2.05.875Z",fill:t})})}var he=6e4;function P(t,e){y(2,arguments);var r=x(e);return se(t,r*he)}function L(t,e){var r=t.getFullYear()-e.getFullYear()||t.getMonth()-e.getMonth()||t.getDate()-e.getDate()||t.getHours()-e.getHours()||t.getMinutes()-e.getMinutes()||t.getSeconds()-e.getSeconds()||t.getMilliseconds()-e.getMilliseconds();return r<0?-1:r>0?1:r}function ge(t,e){y(2,arguments);var r=h(t),s=h(e),i=L(r,s),c=Math.abs(ae(r,s));r.setDate(r.getDate()-i*c);var a=Number(L(r,s)===-i),u=i*(c-a);return u===0?0:u}function fe(t){y(1,arguments);var e=h(t),r=e.getFullYear(),s=e.getMonth(),i=new Date(0);return i.setFullYear(r,s+1,0),i.setHours(0,0,0,0),i.getDate()}function pe(t,e){y(2,arguments);var r=h(t),s=h(e);return r.getTime()>s.getTime()}function _e(t,e){y(2,arguments);var r=h(t),s=h(e);return r.getTime()<s.getTime()}function ye(t,e){y(2,arguments);var r=h(t),s=h(e);return r.getTime()===s.getTime()}function xe(t,e){y(2,arguments);var r=h(t),s=x(e),i=r.getFullYear(),c=r.getDate(),a=new Date(0);a.setFullYear(i,s,15),a.setHours(0,0,0,0);var u=fe(a);return r.setMonth(s,Math.min(c,u)),r}function T(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?T=function(r){return typeof r}:T=function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},T(t)}function Me(t,e){if(y(2,arguments),T(e)!=="object"||e===null)throw new RangeError("values parameter must be an object");var r=h(t);return isNaN(r.getTime())?new Date(NaN):(e.year!=null&&r.setFullYear(e.year),e.month!=null&&(r=xe(r,e.month)),e.date!=null&&r.setDate(x(e.date)),e.hours!=null&&r.setHours(x(e.hours)),e.minutes!=null&&r.setMinutes(x(e.minutes)),e.seconds!=null&&r.setSeconds(x(e.seconds)),e.milliseconds!=null&&r.setMilliseconds(x(e.milliseconds)),r)}function Se(t,e){y(2,arguments);var r=x(e);return P(t,-r)}function ve(t){return t.reduce((s,i)=>{const c=Me(new Date(i.createdAt),{hours:0,minutes:0,seconds:0,milliseconds:0}),a=s.findIndex(u=>ye(u.date,c));return a>-1?(s[a].messages.push(i),s):[...s,{date:c,messages:[i]}]},[]).map(s=>{const i=s.messages.reduce((a,u)=>{const M=new Date(u.createdAt),N=a.findIndex(S=>!S.closed&&S.read===u.read&&S.fromUserId===u.fromUserId&&pe(M,S.since)&&_e(M,S.to));return N>-1?(a[N].content.push(u),a):(a.length>0&&(a[a.length-1].closed=!0),[...a,{closed:!1,content:[u],fromUserId:u.fromUserId,read:u.read,since:Se(M,5),to:P(M,5)}])},[]),c=ge(s.date,new Date);return{messages:i,title:c===0?"Hoy":c===-1?"Ayer":A(s.date,"dd MMMM/yyyy",{locale:ie})}}).map(({messages:s,title:i})=>({messages:s.map(({content:c})=>c),title:i}))}function q({data:t}){const{data:e}=Z(),r=t[0].fromUser;if(!e||!r)return null;const s=e.id===t[0].fromUserId;return n("div",{className:v.chatMessage,children:t.map((i,c)=>l("div",{className:C(v.chatMessage__content,{[v["chatMessage__content--end"]]:s}),children:[!s&&c===0&&n(b,{url:r.profileImage,size:"small"}),l("div",{className:C(v.chatMessage__content__message,{[v["chatMessage__content__message--margin"]]:c>0}),children:[n(m,{withLetterSpacing:!0,className:v.chatMessage__content__message__text,fontSize:14,children:i.content}),c===t.length-1&&n(m,{withLetterSpacing:!0,className:v.chatMessage__content__message__date,fontSize:10,children:A(new Date(i.createdAt),"hh:mm a")})]}),s&&c===0&&n(b,{url:r.profileImage,size:"small"})]},`chat_message_${i.id}_${c}`))})}function we({chatId:t,refetchRecentMessages:e}){var B;const[r,s]=I.exports.useState(""),i=I.exports.useRef(null),c=I.exports.useRef(null),{data:a,loading:u,updateQuery:M,subscribeToMore:N}=G(K,{variables:{chatId:t}}),[S]=U(V,{onCompleted({readAllMessages:d}){!d||(e(),M(g=>({messages:g.messages.map(f=>!f.read&&f.fromUserId===t?{...f,read:!0}:f),profile:g.profile})))}}),[j,{loading:O}]=U(J,{onCompleted({sendMessage:d}){s(""),e(),M(g=>({messages:[...g.messages,d],profile:g.profile})),setTimeout(()=>{c.current&&c.current.focus()},100)}});function R(d){s(d.target.value)}function k(){S({variables:{chatId:t}})}function Q(d){d.key==="Enter"&&r.length>0&&j({variables:{chatId:t,content:r}})}const W=(B=a==null?void 0:a.messages)!=null?B:[],E=ve(W);return I.exports.useEffect(()=>{N({document:X,variables:{chatId:t},updateQuery(d,{subscriptionData:g}){return g.data?(e(),{messages:[...d.messages,g.data.newMessage],profile:d.profile}):d}})},[]),I.exports.useEffect(()=>{!i.current||!(a!=null&&a.messages)||i.current.scrollTo(0,i.current.scrollHeight)},[a]),l(Y,{className:_.chatBox,fullHeight:!0,noPadding:!0,children:[(a==null?void 0:a.profile)&&n("div",{className:_.chatBox__header,children:l(o,{container:!0,alignItems:"center",justifyContent:"space-between",children:[n(o,{item:!0,children:l(o,{container:!0,alignItems:"center",spacing:12,children:[n(o,{item:!0,children:n(b,{url:a.profile.profileImage,size:"small"})}),n(o,{item:!0,children:n(m,{variant:"subtitle",children:a.profile.username})})]})}),n(o,{item:!0,children:n(oe,{color:"white",onClick:()=>{},size:"small",variant:"transparent",children:n(me,{})})})]})}),n("div",{className:_.chatBox__content,ref:i,children:u?n(ce,{id:"chat-messages-loader",text:"Cargando"}):n(ee,{children:E.map(({messages:d,title:g},f)=>{const D=f===E.length-1?d.reduce((p,w)=>!w[0].read&&w[0].fromUserId===t?p+w.length:p,0):0;let $=!1;return l("div",{className:_.chatBox__content__grouped,id:f===E.length-1?"chat-grouped-messages":void 0,children:[n(m,{className:_.chatBox__content__grouped__title,fontSize:12,fontWeight:500,children:g}),n("div",{className:_.chatBox__content__grouped__messages,children:d.map((p,w)=>D>0&&!p[0].read&&p[0].fromUserId===t&&!$?($=!0,l(I.exports.Fragment,{children:[l(m,{withLetterSpacing:!0,className:_.chatBox__content__grouped__messages__unread,fontSize:12,children:[D," mensaje",D===1?"":"s"," no le\xEDdo",D===1?"":"s"]}),n(q,{data:p})]},`chat_message_${t}_${p.length}_${f}_${w}`)):n(q,{data:p},`chat_message_${t}_${p.length}_${f}_${w}`))})]},`chat_grouped_message_${d.length}_${f}`)})})}),(a==null?void 0:a.profile)&&n("div",{className:_.chatBox__footer,children:n(o,{container:!0,children:n(o,{item:!0,xs:"auto",children:n("input",{autoComplete:"off",className:_.chatBox__footer__input,disabled:O,onChange:R,onFocus:k,onKeyDown:Q,placeholder:`Mensaje para ${a.profile.username}`,ref:c,value:r})})})})]})}function Ie({data:t}){const e=te();return n(z,{className:C(F.messagePreview,{[F["messagePreview--active"]]:e.pathname===`/chat/${t.userId}`}),to:`/chat/${t.userId}`,children:l(o,{container:!0,alignItems:"center",spacing:24,children:[n(o,{item:!0,children:n(b,{url:t.profileImage})}),n(o,{item:!0,xs:9,children:l(o,{container:!0,justifyContent:"space-between",children:[n(o,{item:!0,children:n(m,{withLetterSpacing:!0,fontSize:18,fontWeight:500,children:t.username})}),n(o,{item:!0,children:n(m,{fontSize:12,children:A(new Date(t.createdAt),"hh:mm a")})}),n(o,{item:!0,xs:10,children:l(m,{style:{color:"#6A6B70",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},variant:"body",children:[t.isMe?"T\xFA: ":null,t.content]})}),Boolean(t.unread)&&n(o,{item:!0,children:n(le,{counter:t.unread})})]})})]})})}function Ne(){return l(o,{container:!0,fullHeight:!0,alignItems:"center",direction:"column",justifyContent:"center",spacing:16,children:[n(o,{item:!0,xs:4,children:n("img",{alt:"Begin chat",src:"/images/begin-chat.svg",width:"100%"})}),n(o,{item:!0,children:l(o,{container:!0,alignItems:"center",direction:"column",spacing:4,children:[n(o,{item:!0,children:n(m,{variant:"title",children:"Selecciona una conversaci\xF3n"})}),n(o,{item:!0,children:l(m,{variant:"body",children:["Si no tienes una conversaci\xF3n puedes buscar"," ",n(z,{to:"/explore",children:"nuevas conexiones"})]})})]})})]})}function Ce(){var i;const{chatId:t}=ne(),{data:e,refetch:r}=G(re),s=(i=e==null?void 0:e.getRecentMessages)!=null?i:[];return n(ue,{children:n(o,{item:!0,xs:12,children:l(o,{container:!0,fullHeight:!0,spacing:12,children:[n(o,{item:!0,children:n("div",{style:{height:"calc(100vh - 48px)",maxHeight:"calc(100vh - 48px)",width:320},children:l(Y,{fullHeight:!0,noPadding:!0,children:[n(m,{withLetterSpacing:!0,component:"h3",style:{padding:"16px 24px"},variant:"title",children:"Conversaciones"}),s.length>0?s.map((c,a)=>n(Ie,{data:c},`chat_${c.userId}_${a}`)):n(o,{container:!0,alignItems:"center",direction:"column",children:n(o,{item:!0,children:n(m,{children:"No tienes conversaciones"})})})]})})}),l(o,{item:!0,xs:"auto",children:[n(de,{}),n("div",{style:{height:"100%",marginTop:12,maxHeight:"calc(100vh - 48px - 62px)"},children:t?n(we,{chatId:t,refetchRecentMessages:r}):n(Ne,{})})]})]})})})}export{Ce as default};
