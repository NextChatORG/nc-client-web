import{o as g,t as m,p as L,q as ee,s as v,v as B,w as te,j as r,d as P,f as $,x,a as u,g as b,y as E,T as h,r as w,z as Y,D as ne,m as z,E as re,S as se,N as ae,I as G,J as y,G as o,K as ie,O as oe,F as ce,P as le,L as j,Q as O,U as ue,V as de,M as he,W as me,X as ge}from"./index.79a90888.js";function U(n){g(1,arguments);var e=m(n);return e.setHours(0,0,0,0),e}var fe=864e5;function _e(n,e){g(2,arguments);var t=U(n),s=U(e),a=t.getTime()-L(t),c=s.getTime()-L(s);return Math.round((a-c)/fe)}var pe=6e4;function Q(n,e){g(2,arguments);var t=v(e);return ee(n,t*pe)}function q(n,e){var t=n.getFullYear()-e.getFullYear()||n.getMonth()-e.getMonth()||n.getDate()-e.getDate()||n.getHours()-e.getHours()||n.getMinutes()-e.getMinutes()||n.getSeconds()-e.getSeconds()||n.getMilliseconds()-e.getMilliseconds();return t<0?-1:t>0?1:t}function ye(n,e){g(2,arguments);var t=m(n),s=m(e),a=q(t,s),c=Math.abs(_e(t,s));t.setDate(t.getDate()-a*c);var l=Number(q(t,s)===-a),i=a*(c-l);return i===0?0:i}function ve(n){g(1,arguments);var e=m(n),t=e.getFullYear(),s=e.getMonth(),a=new Date(0);return a.setFullYear(t,s+1,0),a.setHours(0,0,0,0),a.getDate()}function Me(n,e){g(2,arguments);var t=m(n),s=m(e);return t.getTime()>s.getTime()}function xe(n,e){g(2,arguments);var t=m(n),s=m(e);return t.getTime()<s.getTime()}function Ie(n,e){g(2,arguments);var t=m(n),s=m(e);return t.getTime()===s.getTime()}function Se(n,e){g(2,arguments);var t=m(n),s=v(e),a=t.getFullYear(),c=t.getDate(),l=new Date(0);l.setFullYear(a,s,15),l.setHours(0,0,0,0);var i=ve(l);return t.setMonth(s,Math.min(c,i)),t}function A(n){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?A=function(t){return typeof t}:A=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},A(n)}function we(n,e){if(g(2,arguments),A(e)!=="object"||e===null)throw new RangeError("values parameter must be an object");var t=m(n);return isNaN(t.getTime())?new Date(NaN):(e.year!=null&&t.setFullYear(e.year),e.month!=null&&(t=Se(t,e.month)),e.date!=null&&t.setDate(v(e.date)),e.hours!=null&&t.setHours(v(e.hours)),e.minutes!=null&&t.setMinutes(v(e.minutes)),e.seconds!=null&&t.setSeconds(v(e.seconds)),e.milliseconds!=null&&t.setMilliseconds(v(e.milliseconds)),t)}function De(n,e){g(2,arguments);var t=v(e);return Q(n,-t)}function Te(n){return n.reduce((s,a)=>{const c=we(new Date(a.createdAt),{hours:0,minutes:0,seconds:0,milliseconds:0}),l=s.findIndex(i=>Ie(i.date,c));return l>-1?(s[l].messages.push(a),s):[...s,{date:c,messages:[a]}]},[]).map(s=>{const a=s.messages.reduce((l,i)=>{const I=new Date(i.createdAt),D=l.findIndex(M=>!M.closed&&M.read===i.read&&M.senderId===i.senderId&&Me(I,M.since)&&xe(I,M.to));return D>-1?(l[D].content.push(i),l):(l.length>0&&(l[l.length-1].closed=!0),[...l,{closed:!1,content:[i],read:i.read,senderId:i.senderId,since:De(I,5),to:Q(I,5)}])},[]),c=ye(s.date,new Date);return{messages:a,title:c===0?"Hoy":c===-1?"Ayer":B(s.date,"dd MMMM/yyyy",{locale:te})}}).map(({messages:s,title:a})=>({messages:s.map(({content:c})=>c),title:a}))}function Ne({color:n=P.color,size:e=P.size,...t}){return r("svg",{...t,height:e,viewBox:"0 0 48 48",width:e,xmlns:"http://www.w3.org/2000/svg",children:r("path",{d:"M24.05 41.7q-1.25 0-2.125-.875t-.875-2.075q0-1.2.875-2.1.875-.9 2.075-.9 1.25 0 2.1.9.85.9.85 2.1 0 1.2-.85 2.075-.85.875-2.05.875Zm0-14.75q-1.25 0-2.125-.875T21.05 24q0-1.25.875-2.1.875-.85 2.075-.85 1.25 0 2.1.85.85.85.85 2.05 0 1.25-.85 2.125t-2.05.875Zm0-14.7q-1.25 0-2.125-.875T21.05 9.25q0-1.25.875-2.125T24 6.25q1.25 0 2.1.875.85.875.85 2.125t-.85 2.125q-.85.875-2.05.875Z",fill:n})})}function R({data:n}){const{data:e}=$(),t=n[0].senderUser;if(!e||!t)return null;const s=e.id===n[0].senderId;return r("div",{className:x.chatMessage,children:n.map((a,c)=>u("div",{className:b(x.chatMessage__content,{[x["chatMessage__content--end"]]:s}),children:[!s&&c===0&&r(E,{url:t.profileImage,size:"small"}),u("div",{className:b(x.chatMessage__content__message,{[x["chatMessage__content__message--margin"]]:c>0}),children:[r(h,{withLetterSpacing:!0,className:x.chatMessage__content__message__text,fontSize:14,children:a.content}),c===n.length-1&&r(h,{withLetterSpacing:!0,className:x.chatMessage__content__message__date,fontSize:10,children:B(new Date(a.createdAt),"hh:mm a")})]}),s&&c===0&&r(E,{url:t.profileImage,size:"small"})]},`chat_message_${a.id}_${c}`))})}function Ae({chatId:n,refetchRecentChats:e}){var F;const[t,s]=w.exports.useState(""),a=w.exports.useRef(null),c=w.exports.useRef(null),{data:l}=$(),{data:i,loading:I,updateQuery:D,subscribeToMore:M}=Y(ne,{variables:{chatId:n}}),[V]=z(re,{onCompleted({readAllMessages:d}){!d||(e(),D(f=>({...f,messages:f.messages.map(_=>!_.read&&_.senderId!==(l==null?void 0:l.id)?{..._,read:!0}:_)})))}}),[W,{loading:k}]=z(se,{onCompleted({sendPrivateMessage:d}){s(""),e(),D(f=>({...f,messages:[...f.messages,d]})),setTimeout(()=>{c.current&&c.current.focus()},100)}});function K(d){s(d.target.value)}function Z(){V({variables:{chatId:n}})}function J(d){d.key==="Enter"&&t.length>0&&W({variables:{chatId:n,content:t}})}const X=(F=i==null?void 0:i.messages)!=null?F:[],C=Te(X);if(w.exports.useEffect(()=>{M({document:ae,variables:{chatId:n},updateQuery(d,{subscriptionData:f}){return f.data?(e(),{...d,messages:[...d.messages,f.data.newPrivateMessage]}):d}})},[]),w.exports.useEffect(()=>{!a.current||!(i!=null&&i.messages)||a.current.scrollTo(0,a.current.scrollHeight)},[i]),!l)return null;const T=(i==null?void 0:i.chat.toId)===l.id?i.chat.user:i==null?void 0:i.chat.toUser;return T?u(G,{className:y.chatBox,fullHeight:!0,noPadding:!0,children:[r("div",{className:y.chatBox__header,children:u(o,{container:!0,alignItems:"center",justifyContent:"space-between",children:[r(o,{item:!0,children:u(o,{container:!0,alignItems:"center",spacing:12,children:[r(o,{item:!0,children:r(E,{url:T.profileImage,size:"small"})}),r(o,{item:!0,children:r(h,{variant:"subtitle",children:T.username})})]})}),r(o,{item:!0,children:r(ie,{color:"white",onClick:()=>{},size:"small",variant:"transparent",children:r(Ne,{})})})]})}),r("div",{className:y.chatBox__content,ref:a,children:I?r(oe,{id:"chat-messages-loader",text:"Cargando"}):r(ce,{children:C.map(({messages:d,title:f},_)=>{const N=_===C.length-1?d.reduce((p,S)=>!S[0].read&&S[0].senderId!==l.id?p+S.length:p,0):0;let H=!1;return u("div",{className:y.chatBox__content__grouped,id:_===C.length-1?"chat-grouped-messages":void 0,children:[r(h,{className:y.chatBox__content__grouped__title,fontSize:12,fontWeight:500,children:f}),r("div",{className:y.chatBox__content__grouped__messages,children:d.map((p,S)=>N>0&&!p[0].read&&p[0].senderId!==l.id&&!H?(H=!0,u(w.exports.Fragment,{children:[u(h,{withLetterSpacing:!0,className:y.chatBox__content__grouped__messages__unread,fontSize:12,children:[N," mensaje",N===1?"":"s"," no le\xEDdo",N===1?"":"s"]}),r(R,{data:p})]},`chat_message_${n}_${p.length}_${_}_${S}`)):r(R,{data:p},`chat_message_${n}_${p.length}_${_}_${S}`))})]},`chat_grouped_message_${d.length}_${_}`)})})}),r("div",{className:y.chatBox__footer,children:r(o,{container:!0,children:r(o,{item:!0,xs:"auto",children:r("input",{autoComplete:"off",className:y.chatBox__footer__input,disabled:k,onChange:K,onFocus:Z,onKeyDown:J,placeholder:`Mensaje para ${T.username}`,ref:c,value:t})})})})]}):null}function Ee({data:n}){const{data:e}=$(),t=le();if(e==null)return null;const s=n.chat.toId===e.id?n.chat.user:n.chat.toUser;return s?r(j,{className:b(O.messagePreview,{[O["messagePreview--active"]]:t.pathname===`/chat/${n.chat.id}`}),to:`/chat/${n.chat.id}`,children:u(o,{container:!0,alignItems:"center",spacing:24,children:[r(o,{item:!0,children:r(E,{url:s.profileImage})}),r(o,{item:!0,xs:9,children:u(o,{container:!0,justifyContent:"space-between",children:[r(o,{item:!0,children:r(h,{withLetterSpacing:!0,fontSize:18,fontWeight:500,children:s.username})}),r(o,{item:!0,children:r(h,{fontSize:12,children:B(new Date(n.lastMessage.createdAt),"hh:mm a")})}),r(o,{item:!0,xs:10,children:u(h,{style:{color:"#6A6B70",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},variant:"body",children:[n.lastMessage.senderId===e.id?"T\xFA: ":null,n.lastMessage.content]})}),Boolean(n.unread)&&r(o,{item:!0,children:r(ue,{counter:n.unread})})]})})]})}):null}function Ce(){return u(o,{container:!0,fullHeight:!0,alignItems:"center",direction:"column",justifyContent:"center",spacing:16,children:[r(o,{item:!0,xs:4,children:r("img",{alt:"Begin chat",src:"/images/begin-chat.svg",width:"100%"})}),r(o,{item:!0,children:u(o,{container:!0,alignItems:"center",direction:"column",spacing:4,children:[r(o,{item:!0,children:r(h,{variant:"title",children:"Selecciona una conversaci\xF3n"})}),r(o,{item:!0,children:u(h,{variant:"body",children:["Si no tienes una conversaci\xF3n puedes buscar"," ",r(j,{to:"/explore",children:"nuevas conexiones"})]})})]})})]})}function Be(){var a;const{chatId:n}=de(),{data:e,refetch:t}=Y(ge),s=(a=e==null?void 0:e.getRecentChats)!=null?a:[];return r(he,{children:r(o,{item:!0,xs:12,children:u(o,{container:!0,fullHeight:!0,spacing:12,children:[r(o,{item:!0,children:r("div",{style:{height:"calc(100vh - 48px)",maxHeight:"calc(100vh - 48px)",width:320},children:u(G,{fullHeight:!0,noPadding:!0,children:[r(h,{withLetterSpacing:!0,component:"h3",style:{padding:"16px 24px"},variant:"title",children:"Conversaciones"}),s.length>0?s.map((c,l)=>r(Ee,{data:c},`chat_${c.chat.id}_${l}`)):r(o,{container:!0,alignItems:"center",direction:"column",children:r(o,{item:!0,children:r(h,{children:"No tienes conversaciones"})})})]})})}),u(o,{item:!0,xs:"auto",children:[r(me,{}),r("div",{style:{height:"100%",marginTop:12,maxHeight:"calc(100vh - 48px - 62px)"},children:n?r(Ae,{chatId:n,refetchRecentChats:t}):r(Ce,{})})]})]})})})}export{Be as default};
