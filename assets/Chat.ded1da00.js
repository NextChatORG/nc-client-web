import{t as h,v as R,w as y,x as u,y as D,z as B,j as s,d as b,n as v,F as T,a as d,c as p,E as L,r as x,B as N,U,G as I,q as Y,I as q,J as H,K as O,N as j,e as S,O as P,M as z,Q as M}from"./index.b8cddd1d.js";import{d as F}from"./index.4649c596.js";var V=6e4;function $(a,e){h(2,arguments);var t=y(e);return R(a,t*V)}function k(a,e){h(2,arguments);var t=u(a),n=u(e),r=t.getTime()-n.getTime();return r<0?-1:r>0?1:r}function Z(a,e){h(2,arguments);var t=u(a),n=u(e);return t.getFullYear()-n.getFullYear()}function K(a,e){h(2,arguments);var t=u(a),n=u(e),r=k(t,n),l=Math.abs(Z(t,n));t.setFullYear(1584),n.setFullYear(1584);var o=k(t,n)===-r,c=r*(l-Number(o));return c===0?0:c}function W(a){h(1,arguments);var e=u(a),t=e.getFullYear(),n=e.getMonth(),r=new Date(0);return r.setFullYear(t,n+1,0),r.setHours(0,0,0,0),r.getDate()}function G(a,e){h(2,arguments);var t=u(a),n=u(e);return t.getTime()>n.getTime()}function J(a,e){h(2,arguments);var t=u(a),n=u(e);return t.getTime()<n.getTime()}function Q(a,e){h(2,arguments);var t=u(a),n=u(e);return t.getTime()===n.getTime()}function X(a,e){h(2,arguments);var t=u(a),n=y(e),r=t.getFullYear(),l=t.getDate(),o=new Date(0);o.setFullYear(r,n,15),o.setHours(0,0,0,0);var c=W(o);return t.setMonth(n,Math.min(l,c)),t}function w(a){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?w=function(t){return typeof t}:w=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},w(a)}function ee(a,e){if(h(2,arguments),w(e)!=="object"||e===null)throw new RangeError("values parameter must be an object");var t=u(a);return isNaN(t.getTime())?new Date(NaN):(e.year!=null&&t.setFullYear(e.year),e.month!=null&&(t=X(t,e.month)),e.date!=null&&t.setDate(y(e.date)),e.hours!=null&&t.setHours(y(e.hours)),e.minutes!=null&&t.setMinutes(y(e.minutes)),e.seconds!=null&&t.setSeconds(y(e.seconds)),e.milliseconds!=null&&t.setMilliseconds(y(e.milliseconds)),t)}function te(a,e){h(2,arguments);var t=y(e);return $(a,-t)}function ae(a){return a.reduce((n,r)=>{const l=ee(new Date(r.createdAt),{hours:0,minutes:0,seconds:0,milliseconds:0}),o=n.findIndex(c=>Q(c.date,l));return o>-1?(n[o].messages.push(r),n):[...n,{date:l,messages:[r]}]},[]).map(n=>{const r=n.messages.reduce((o,c)=>{const m=new Date(c.createdAt),g=o.findIndex(i=>!i.closed&&i.read===c.read&&i.senderId===c.senderId&&G(m,i.since)&&J(m,i.to));return g>-1?(o[g].content.push(c),o):(o.length>0&&(o[o.length-1].closed=!0),[...o,{closed:!1,content:[c],read:c.read,senderId:c.senderId,since:te(m,5),to:$(m,5)}])},[]),l=F(n.date,new Date);return{messages:r,title:l===0?"Hoy":l===-1?"Ayer":D(n.date,"dd MMMM/yyyy",{locale:B})}}).map(({messages:n,title:r})=>({messages:n.map(({content:l})=>l),title:r}))}function E({color:a=b.color,size:e=b.size,...t}){return s("svg",{...t,height:e,viewBox:"0 0 48 48",width:e,xmlns:"http://www.w3.org/2000/svg",children:s("path",{d:"M28.05 36 16 23.95 28.05 11.9l2.15 2.15-9.9 9.9 9.9 9.9Z",fill:a})})}function ne({color:a=b.color,size:e=b.size,...t}){return s("svg",{...t,height:e,viewBox:"0 0 48 48",width:e,xmlns:"http://www.w3.org/2000/svg",children:s("path",{d:"M24.05 41.7q-1.25 0-2.125-.875t-.875-2.075q0-1.2.875-2.1.875-.9 2.075-.9 1.25 0 2.1.9.85.9.85 2.1 0 1.2-.85 2.075-.85.875-2.05.875Zm0-14.75q-1.25 0-2.125-.875T21.05 24q0-1.25.875-2.1.875-.85 2.075-.85 1.25 0 2.1.85.85.85.85 2.05 0 1.25-.85 2.125t-2.05.875Zm0-14.7q-1.25 0-2.125-.875T21.05 9.25q0-1.25.875-2.125T24 6.25q1.25 0 2.1.875.85.875.85 2.125t-.85 2.125q-.85.875-2.05.875Z",fill:a})})}function C({data:a}){const{data:e}=v(),t=a[0].senderUser;if(!e||!t)return null;const n=e.id===a[0].senderId;return s(T,{children:a.map((r,l)=>d("div",{className:p("w-full flex flex-wrap items-start content-start justify-start gap-1 px-2",{"justify-end":n,"mt-[4px]":l>0}),children:[!n&&l===0&&s("img",{alt:`${t.username}'s profile`,className:"avatar-small",src:t.profileImage}),d("div",{className:p("flex-1 flex flex-col items-start gap-[4px]",l>0?n?"pr-[37px]":"pl-[37px]":"",{"items-end":n}),children:[s("p",{className:p("max-w-[70%] px-1 py-[6px] text-sm tracking-wide",n?"bg-dark-500":"bg-dark-800",n?l===0?"rounded-tl-md rounded-b-md":"rounded-md":l===0?"rounded-tr-md rounded-b-md":"rounded-md"),children:r.content}),l===a.length-1&&s("span",{className:p("text-xs tracking-wide",n?"mr-[4px]":"ml-[4px]"),children:D(new Date(r.createdAt),"hh:mm a")})]}),n&&l===0&&s("img",{alt:`${t.username}'s profile`,className:"avatar-small",src:t.profileImage})]},`chat_message_${r.id}_${l}`))})}function se({chatId:a,loading:e,messages:t}){const{data:n}=v(),r=ae(t);return d(T,{children:[e&&s(L,{id:"chat-messages-loader",text:"Cargando"}),r.map(({messages:l,title:o},c)=>{const m=c===r.length-1?l.reduce((i,f)=>!f[0].read&&f[0].senderId!==(n==null?void 0:n.id)?i+f.length:i,0):0;let g=!1;return d(x.exports.Fragment,{children:[s("h4",{className:"py-1 text-center text-[12px] font-medium",children:o}),l.map((i,f)=>m>0&&!i[0].read&&i[0].senderId!==(n==null?void 0:n.id)&&!g?(g=!0,d(x.exports.Fragment,{children:[d("h6",{className:p("rounded-md bg-red-500 text-center text-[13px] font-medium tracking-wide","max-w-[50%] sm:max-w-[30%] lg:max-w-[40%] xl:max-w-[20%] mx-auto my-1 py-[6px]"),children:[m," mensaje",m===1?"":"s"," no le\xEDdo",m===1?"":"s"]}),s(C,{data:i})]},`chat_message_${a}_${i.length}_${c}_${f}`)):s("div",{className:f>0?"mt-1":void 0,children:s(C,{data:i})},`chat_message_${a}_${i.length}_${c}_${f}`))]},`chat_grouped_message_${l.length}_${c}`)})]})}function re({onBackClick:a,user:e}){return d("section",{className:"basis-full bg-dark-700 p-2 sm:rounded-lg lg:basis-1/3 xl:basis-1/4 xl:py-3",children:[s(N,{className:"mb-2 lg:hidden",color:"white",onClick:a,size:"extra-small",startIcon:s(E,{size:"1.25em"}),children:"Volver"}),s("img",{alt:`${e.username}'s profile`,className:"avatar-big mx-auto",src:e.profileImage}),s("h4",{className:"mt-1 text-center text-xl font-medium tracking-wide xl:mt-2",children:e.username}),s(N,{fullWidth:!0,link:!0,className:"mt-2 xl:mt-3",color:"white",size:"small",to:U.replace(":username",e.username),variant:"outlined",children:"Ver perfil"}),s(N,{fullWidth:!0,className:"mt-1",color:"error",onClick:()=>{},size:"small",children:"Eliminar amistad"})]})}function le({chatId:a,user:e}){const[t,n]=x.exports.useState(""),r=x.exports.useRef(null),{loadRecentChats:l,readAllMessages:o}=I(),{data:c}=v(),[m,{loading:g}]=Y(q,{onCompleted(){n(""),l()}});function i(_){n(_.target.value)}function f(){c&&o(a,c.id)}function A(_){_.key!=="Enter"||g||!t||m({variables:{chatId:a,content:t}})}return s("footer",{className:"bg-dark-600 w-full px-2 py-1",children:s("input",{autoComplete:"off",className:"rounded-lg bg-dark-700 w-[85%] sm:w-full px-2 py-1",onChange:i,onFocus:f,onKeyDown:A,placeholder:`Mensaje para ${e.username}`,ref:r,value:t})})}function ie({onOpenDetailsClick:a,user:e}){return d("header",{className:"bg-dark-600 flex items-center p-1 lg:pl-2 gap-[8px]",children:[s(N,{link:!0,className:"lg:hidden",color:"white",to:H,variant:"icon",children:s(E,{size:"1.25em"})}),d("div",{className:"flex-1 flex items-center justify-between",children:[d("button",{className:"flex items-center gap-1",onClick:a,children:[s("img",{alt:`${e.username}'s chat`,className:"avatar-normal",src:e.profileImage}),s("p",{className:"text-lg font-medium tracking-wide",children:e.username})]}),s(N,{color:"white",onClick:a,variant:"icon",children:s(ne,{size:"1.25em"})})]})]})}function oe({chatId:a,className:e}){const[t,n]=x.exports.useState(!1),[r,l]=x.exports.useState(!1),o=x.exports.useRef(null),{chats:c,loadChat:m}=I(),{data:g}=v(),i=c[a];if(x.exports.useEffect(()=>{i!=null&&i.chat||(l(!0),m(a).finally(()=>l(!1)))},[a]),x.exports.useEffect(()=>{!o.current||!(i!=null&&i.messages)||o.current.scrollTo(0,o.current.scrollHeight)},[i]),!(i!=null&&i.chat)||!g)return null;const f=i.chat.toId===g.id?i.chat.user:i.chat.toUser;return f?d("div",{className:p(e,"flex gap-2 lg:flex-1 lg:max-h-[calc(100vh_-_58px_-_72px)]"),children:[d("section",{className:p("flex-1 bg-dark-700 sm:rounded-lg sm:overflow-hidden ",{"<lg:hidden":t}),children:[s(ie,{onOpenDetailsClick:()=>n(!t),user:f}),s("div",{className:p("overflow-y-auto h-full max-h-[calc(100%_-_69px_-_72px)] pb-1","scrollbar-thin scrollbar-thumb-dark-800 hover:scrollbar-thumb-dark-900"),ref:o,children:s(se,{chatId:a,loading:r,messages:i.messages})}),s(le,{chatId:a,user:f})]}),t&&s(re,{onBackClick:()=>n(!1),user:f})]}):null}function ce({data:a}){const{data:e}=v(),t=O();if(e==null)return null;const n=a.chat.toId===e.id?a.chat.user:a.chat.toUser;if(!n)return null;const r=new Date(a.lastMessage.createdAt).setHours(0,0,0,0),l=new Date().setHours(0,0,0,0),o=F(l,r),c=K(l,r),m=j.replace(":chatId",a.chat.id.toString());return d(S,{className:p("flex items-center gap-2 py-1 px-2 transition-colors hover:no-underline",t.pathname===m?"bg-white/5":"hover:bg-white/2"),to:m,children:[s("img",{alt:`${n.username}'s chat`,className:"avatar-normal",src:n.profileImage}),d("div",{className:"flex-1",children:[d("div",{className:"flex items-center justify-between",children:[s("h6",{className:"text-lg font-medium tracking-wide",children:n.username}),s("span",{className:"text-xs tracking-wide",children:o===1?"Ayer":D(new Date(a.lastMessage.createdAt),o===0?"hh:mm a":`dd/MM${c===0?"":"/yy"}`)})]}),d("div",{className:"flex items-start justify-between gap-x-1",children:[d("p",{className:"flex-1 text-sm break-all tracking-wide",children:[a.lastMessage.senderId===e.id?"T\xFA: ":null,a.lastMessage.content.slice(0,80),a.lastMessage.content.length>80&&"..."]}),Boolean(a.unread)&&s("span",{className:"badge-normal bg-primary",children:a.unread})]})]})]})}function de(){return d("div",{className:"flex-1 hidden lg:flex flex-col items-center justify-center",children:[s("img",{alt:"Begin chat",className:"w-[30%]",src:"/images/begin-chat.svg"}),s("h4",{className:"mt-2 text-center text-title",children:"Selecciona una conversaci\xF3n"}),d("p",{className:"mt-[8px] text-center text-body",children:["Si no tienes una conversaci\xF3n puedes buscar"," ",s(S,{className:"underline",to:"/explore",children:"nuevas conexiones"})]})]})}function fe(){const{recentChats:a,unreadChats:e}=I(),{chatId:t}=P(),n="h-[calc(100vh_-_82px)] sm:h-[calc(100vh_-_70px_-_48px)] lg:h-[calc(100vh_-_48px)]";return s(z,{noPadding:!0,children:d("div",{className:"relative basis-full lg:flex lg:gap-2 sm:p-2",children:[s(M,{className:"p-1 sm:px-0 sm:pt-0 lg:hidden"}),d("section",{className:p("bg-dark-700 sm:rounded-lg lg:basis-1/3 xl:basis-1/5 xl:min-w-[320px]",n,{"<lg:hidden":Boolean(t)}),children:[d("h3",{className:"flex items-center gap-[8px] text-title py-[16px] px-2",children:["Conversaciones",Boolean(e)&&s("span",{className:"badge-normal bg-primary",children:e})]}),a.length>0?a.map((r,l)=>s(ce,{data:r},`chat_${r.chat.id}_${l}`)):s("p",{className:"pt-1 text-body text-center",children:"No tienes conversaciones"})]}),d("div",{className:"lg:flex-1 lg:flex lg:flex-col lg:gap-2",children:[s(M,{className:"<lg:hidden"}),t?s(oe,{chatId:t,className:n}):s(de,{})]})]})})}export{fe as default};
